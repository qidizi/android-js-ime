<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>工具</title>
    <style>
        * {
            box-sizing: border-box;
        }

        textarea {
            width: 100%;
            display: block;
            height: 100px;
        }

        input.w100 {
            width: 100%;
        }
    </style>
</head>
<body>
<textarea id="log"></textarea>

<fieldset>
    <legend>
        整理
        <input type="button" onclick="clean_repeat(gid('clean_var'));" value="开始"/>
        <input type="checkbox" id="clean_confirm"/> 要确认
        <input type="button" id="clean_no" value="剔除"/>
        <input type="button" id="clean_yes" value="收入"/>
        <b id="clean_kw">待开始</b>

    </legend>
    <input class="w100" id="clean_var" placeholder="粘贴vue_wu_bi_a-z.js内容到此，点开始后复制使用">
</fieldset>
<script>
    function ajax(src, cb, method, body) {
        let xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if (4 === xhr.readyState && 200 === xhr.status) {
                'function' === typeof cb && cb.call(xhr, xhr.responseText);
            }
        };
        xhr.open(method || 'GET', src);
        xhr.send(body);
    }

    let cn_order;
    ajax('cn_order.txt', function (str) {
        cn_order = str.replace(/\s+/g, '');
    });

    // 致善词表处理
    function ys168() {
        ajax('vue_wu_bi_dict.txt', function (str) {
            str = str.trim().split('\n');
            let dict = [];
            str.forEach(function (line) {
                line = line.trim().replace(/\s+/, ' ');
                line = line.split(' ');
                let key = line[1];
                let word = line[0];
                let no_exists = false;
                word.split('').forEach(function (w) {
                    if (cn_order.indexOf(w) < 0) {
                        no_exists = true;
                    }
                });

                if (no_exists) {
                    // 常用字中没有，这个词可以不要了。
                    return;
                }

                let code = key[0].charCodeAt(0);
                if (!dict[code]) dict[code] = [];
                dict[code].push(key + ' ' + word);
            });

            let tmp = [];
            dict.forEach(function (array) {
                if (!array || !array.length) return;
                tmp = tmp.concat(array);
            });
            let blob = new Blob([tmp.join('\n')], {type: 'plain/text'});
            let url = window.URL.createObjectURL(blob);
            let a = document.createElement('a');
            a.href = url;
            a.download = 'vue_wu_bi_dict.txt';
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);// 释放createObjectURL对象
        });
    }

    function gid(str) {
        return document.getElementById(str);
    }

    function log(msg) {
        gid('log').value = msg + "\n" + gid('log').value;
    }

    function clean_repeat(input) {
        gid('clean_kw').innerText = '';
        let val = input.value.trim().replace(/[;"']/g, '');
        val = val.split('=');
        let var_name = val[0].trim();
        val = val[1].trim();
        val = val.replace(/\s*,\s*/g, ',');
        val = val.replace(/\s{2,}/g, ' ');
        val = val.split(',');
        let clean = {};
        let clean_i = 0;
        run();

        function run() {
            if (!val[clean_i]) return done();
            let kw = val[clean_i++].split(' ');
            let word = kw[1];
            let key = kw[0].toLowerCase();
            let no_exists = false;
            word.split('').forEach(function (w) {
                if (cn_order.indexOf(w) < 0) {
                    no_exists = true;
                }
            });

            if (no_exists) {
                // 常用字中没有，这个词可以不要了。
                log('非常用：' + kw);
                run();
                return;
            }

            if (2 !== kw.length || !/^[a-z]+$/i.test(key)) {
                log('无效格式： ' + kw);
                run();
                return;
            }

            if (false === clean[word]) {
                // 已经剔除
                run();
                return;
            }

            if (clean[word] && (clean[word] !== key && clean[word].length === key.length)) {
                log('多重编码：忽略-' + kw + ' 与 收录-' + clean[word]);
                run();
                return;
            }

            if (false === clean[word] || (clean[word] && (key.length < clean[word].length))) {
                // 比收录短，剔除
                run();
                return;
            }

            if ('undefined' === typeof clean[word] && gid('clean_confirm').checked) {
                // 未收录的，需要确认
                gid('clean_yes').onclick = function () {
                    clean[word] = key;
                    run();
                };
                gid('clean_no').onclick = function () {
                    // 防止下回再提示，
                    clean[word] = false;
                    run();
                };
                gid('clean_kw').innerText = '请确认：' + kw;
                return;
            }

            clean[word] = key;
            run();
        }

        function done() {
            val = [];

            for (let w in clean) {
                // false的，要剔除
                if (!clean[w]) continue;
                val.push(clean[w] + ' ' + w);
            }

            // 按常用字顺序来排列
            val.sort(function (a, b) {
                a = a.split(' ')[1].split('');
                b = b.split(' ')[1].split('');
                let max = Math.max(a.length, b.length);
                let index = -1;
                // 按当前位置的字比较得到大小
                while (++index < max) {
                    let ai = a[index];
                    let bi = b[index];

                    if (ai === bi) continue;
                    return cn_order.indexOf(ai) > cn_order.indexOf(bi) ? 1 : -1;
                }

                return 0;
            });
            input.value = var_name + ' = "' + val.join(',') + '";\n';
            gid('clean_kw').innerText = '处理完成';
        }
    }
</script>
</body>
</html>